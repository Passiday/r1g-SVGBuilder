<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SVG modelēšana</title>
  <script type="text/javascript" src="js/SVGBuilder.js"></script>
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript">

    window.onload = function() {
      document.getElementById("speedTest").addEventListener("click", speedTest);
    }

    function randomRGB(e) {
      var r = Math.floor(Math.random() * 0x100);
      var g = Math.floor(Math.random() * 0x100);
      var b = Math.floor(Math.random() * 0x100);
      var randomRGB = "#" + (0x1000000 + (r << 16) + (g << 8) + b).toString(16).substr(1);
      return randomRGB;
    }

    var testRunning;

    function speedTest() {

      if (testRunning) clearTimeout(testRunning);

      svg = new SVGBuilder();
      svg.insert(document.getElementById("svg-container"), true);

      let realFpsSvg = svg.addText({x:5, y:15}, "");
      let correctionSvg = svg.addText({x:5, y:30}, "");

      let bugs = [];
      let bugCount = 500;
      let targetFps = 40;

      let cx = 350, cy = 200;
      svg.addCircle({cx:cx, cy:cy, r:5, style:{fill:"red"}});

      /*
      let defs = svg.addDefs();
      defs.addRect({id:"bug", x:-5, y:-25, width:10, height:50});
      */

      for (let i = 0; i < bugCount; i++) {
        let bug = {
          radius: 10 + 290 * Math.sqrt(Math.random()),
          angle : 360 * Math.random() * Math.PI / 180
        }
        bug.speed = (30 + 5 * Math.random()) * Math.PI / 180 / bug.radius;
        bug.svg = svg.addRect({x:-5, y:-25, width:10, height:50, style:{fill:randomRGB(), fillOpacity:0.8}});
        //bug.svg = svg.addUse({style:{fill:randomRGB(), fillOpacity:0.8}}, "bug");
        bugs.push(bug);
      };

      let timeLog = [];
      let correctionSpan = 10; // Number of periods over which the period adjustment is calculated
      let targetPeriod = 1000 / targetFps;
      let timeoutMs = targetPeriod;

      function moveBugs() {
        // Calculate the next redraw time to maintain stable fps
        let curTime = new Date().getTime();
        if (timeLog.length > correctionSpan) {
          let baseTime = timeLog.shift();
          let realPeriod = (curTime - baseTime) / correctionSpan;
          timeoutMs += (1 / correctionSpan) * (targetPeriod - realPeriod);
          if (timeoutMs < 0) {
            console.error("Impossible to keep up the target framerate!");
            timeoutMs = 0;
          }
          realFpsSvg.setValue("Real fps: " + Math.floor(100000 / realPeriod) / 100);
          correctionSvg.setValue("Correction: " + Math.round(targetPeriod - timeoutMs));
        }
        timeLog.push(curTime);

        // Move the bugs
        bugs.forEach(bug => {
          bug.angle += bug.speed;
          bug.svg.translate(cx + Math.cos(bug.angle) * bug.radius, cy + Math.sin(bug.angle) * bug.radius);
          bug.svg.rotate(bug.angle / Math.PI * 180);
        });

        testRunning = window.setTimeout(moveBugs, timeoutMs);
      }
      moveBugs();
    }

  </script>
</head>
<body>
  <h1>SVGBuilder: SVG modelēšana ar JavaScript</h1>
  <p class="note">
    Demo: animētu objektu stresa tests.
  </p>
  <button id="speedTest">Run test</button>
  <div id="svg-container">Šo tekstu nomainīs SVG elements</div>
</body>
</html>
